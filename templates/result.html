<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-white">
    <div class="container py-5">
      <div class="row">
        <div class="col-md-6">
          <h1 class="mb-3">Personalized suggestions for {{ profile.name }}</h1>

          <h4>Profile</h4>
          <ul>
            <li>Age: {{ profile.age }}</li>
            <li>Diseases: {{ profile.diseases | join(', ') }}</li>
          </ul>

          <h4>HCI Recommendations</h4>
          <p>{{ profile.hci }}</p>

          <h4>Health Suggestions</h4>
          <ul>
          {% for s in profile.suggestions %}
            <li>{{ s }}</li>
          {% endfor %}
          </ul>

          <a href="/" class="btn btn-secondary mt-3">Back</a>
        </div>

        <div class="col-md-6">
          <div class="card p-3">
            <h5>Weather & HCI Widget</h5>
            <div class="mb-2">
              <input id="location-input" class="form-control" placeholder="Enter city or 'lat,lon'" />
            </div>
            <div class="d-flex gap-2 mb-2">
              <select id="units" class="form-select w-50"><option value="metric">Celsius</option><option value="imperial">Fahrenheit</option></select>
              <select id="forecast_days" class="form-select w-50"><option value="0">Now</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
            </div>
            <div class="form-check mb-2"><input id="include_aqi" type="checkbox" class="form-check-input"/><label class="form-check-label">Include AQI</label></div>
            <button id="fetch-weather-btn" class="btn btn-outline-primary mb-2">Get Weather</button>

            <div id="status-message" class="small text-muted"></div>

            <div class="mt-3">
              <div><strong id="loc">--</strong></div>
              <div class="d-flex align-items-center gap-2"><img id="cond_icon" src="" style="width:36px;height:36px;display:none"/><div id="cond">--</div></div>
              <div class="mt-2">Temp: <span id="temp">--</span></div>
              <div>Humidity: <span id="hum">--</span></div>
              <div>Wind: <span id="wind">--</span></div>
              <div class="mt-2">HCI: <span id="hci-value">--</span> <span id="comfort-badge">--</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const fetchButton = document.getElementById('fetch-weather-btn');
        const locInput = document.getElementById('location-input');
        const status = document.getElementById('status-message');

        const outLoc = document.getElementById('loc');
        const outCond = document.getElementById('cond');
        const outTemp = document.getElementById('temp');
        const outHum = document.getElementById('hum');
        const outWind = document.getElementById('wind');

        async function fetchWeather(){
          const q = locInput.value || 'London';
          const units = document.getElementById('units').value;
          const days = parseInt(document.getElementById('forecast_days').value, 10);
          const include_aqi = document.getElementById('include_aqi').checked;
          fetchButton.disabled = true;
          status.textContent = 'Fetching...';
          try{
            const r = await fetch('/api/get_weather', {
              method: 'POST', headers: {'Content-Type':'application/json'},
              body: JSON.stringify({query: q, units: units, forecast_days: days, include_aqi: include_aqi})
            });
            const data = await r.json();
            if(!r.ok){ status.textContent = data.error || 'Error'; return; }
            outLoc.textContent = data.location_name;
            outCond.textContent = data.condition;
            outTemp.textContent = data.temperature_c + (units === 'metric' ? ' °C' : ' °F');
            const hciVal = document.getElementById('hci-value');
            const comfortBadge = document.getElementById('comfort-badge');
            if(data.hci){ hciVal.textContent = data.hci; } else { hciVal.textContent = '--'; }
            if(data.comfort_level){ comfortBadge.textContent = `${data.comfort_emoji} ${data.comfort_level}`; }
            const iconEl = document.getElementById('cond_icon');
            if(data.condition_icon){ iconEl.src = data.condition_icon.startsWith('//') ? 'https:' + data.condition_icon : data.condition_icon; iconEl.style.display = 'inline-block'; } else { iconEl.style.display = 'none'; }
            outHum.textContent = data.humidity + ' %';
            outWind.textContent = data.wind_speed + ' m/s';
            status.textContent = 'Updated: ' + (data.local_time || '');
          }catch(e){ status.textContent = 'Network error'; }finally{ fetchButton.disabled = false; }
        }

        fetchButton.addEventListener('click', fetchWeather);
        locInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') fetchWeather(); });
      });
    </script>
  </body>
</html>
